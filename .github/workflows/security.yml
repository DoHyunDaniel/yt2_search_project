name: ğŸ”’ ë³´ì•ˆ ìŠ¤ìº”

on:
  schedule:
    - cron: '0 2 * * 1'  # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 2ì‹œ
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # =============================================================================
  # ğŸ›¡ï¸ ì¢…í•© ë³´ì•ˆ ìŠ¤ìº”
  # =============================================================================
  security-scan:
    name: ğŸ›¡ï¸ ë³´ì•ˆ ìŠ¤ìº”
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸ Python ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ ë³´ì•ˆ ë„êµ¬ ì„¤ì¹˜
      run: |
        pip install safety bandit semgrep pip-audit
        
    - name: ğŸ” ì˜ì¡´ì„± ì·¨ì•½ì  ìŠ¤ìº” (Safety)
      run: |
        echo "## ğŸ” ì˜ì¡´ì„± ì·¨ì•½ì  ìŠ¤ìº” (Safety)" >> $GITHUB_STEP_SUMMARY
        safety check -r api/requirements.txt -r crawler/requirements.txt --json > safety-report.json || true
        safety check -r api/requirements.txt -r crawler/requirements.txt >> $GITHUB_STEP_SUMMARY || true
        
    - name: ğŸ›¡ï¸ Python ë³´ì•ˆ ì½”ë“œ ë¶„ì„ (Bandit)
      run: |
        echo "## ğŸ›¡ï¸ Python ë³´ì•ˆ ì½”ë“œ ë¶„ì„ (Bandit)" >> $GITHUB_STEP_SUMMARY
        bandit -r api/ -f json -o bandit-api-report.json || true
        bandit -r crawler/ -f json -o bandit-crawler-report.json || true
        bandit -r api/ -f txt >> $GITHUB_STEP_SUMMARY || true
        bandit -r crawler/ -f txt >> $GITHUB_STEP_SUMMARY || true
        
    - name: ğŸ” ì •ì  ë¶„ì„ (Semgrep)
      run: |
        echo "## ğŸ” ì •ì  ë¶„ì„ (Semgrep)" >> $GITHUB_STEP_SUMMARY
        semgrep --config=auto api/ crawler/ --json -o semgrep-report.json || true
        semgrep --config=auto api/ crawler/ >> $GITHUB_STEP_SUMMARY || true
        
    - name: ğŸ“Š ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports-${{ github.run_number }}
        path: |
          safety-report.json
          bandit-api-report.json
          bandit-crawler-report.json
          semgrep-report.json

  # =============================================================================
  # ğŸ” ì‹œí¬ë¦¿ ìŠ¤ìº” (GitHub ê¸°ë³¸ ê¸°ëŠ¥ ì‚¬ìš©)
  # =============================================================================
  secret-scan:
    name: ğŸ” ì‹œí¬ë¦¿ ìŠ¤ìº”
    runs-on: ubuntu-latest
    if: github.event_name != 'schedule'  # ìŠ¤ì¼€ì¤„ ì‹¤í–‰ ì‹œ ì œì™¸
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ğŸ” ê¸°ë³¸ ì‹œí¬ë¦¿ ìŠ¤ìº”
      run: |
        echo "## ğŸ” ì‹œí¬ë¦¿ ìŠ¤ìº” ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
        
        # ì¼ë°˜ì ì¸ ì‹œí¬ë¦¿ íŒ¨í„´ ê²€ì‚¬
        echo "### ğŸ” API í‚¤ íŒ¨í„´ ê²€ì‚¬" >> $GITHUB_STEP_SUMMARY
        
        # API í‚¤ íŒ¨í„´ ê²€ì‚¬
        if grep -r "sk-[a-zA-Z0-9]" . --exclude-dir=.git --exclude-dir=node_modules --exclude-dir=__pycache__; then
          echo "âš ï¸  OpenAI API í‚¤ íŒ¨í„´ ë°œê²¬" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… OpenAI API í‚¤ íŒ¨í„´ ì—†ìŒ" >> $GITHUB_STEP_SUMMARY
        fi
        
        if grep -r "AIza[0-9A-Za-z_-]{35}" . --exclude-dir=.git --exclude-dir=node_modules --exclude-dir=__pycache__; then
          echo "âš ï¸  YouTube API í‚¤ íŒ¨í„´ ë°œê²¬" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… YouTube API í‚¤ íŒ¨í„´ ì—†ìŒ" >> $GITHUB_STEP_SUMMARY
        fi
        
        if grep -r "password.*=.*[^YOUR_]" . --exclude-dir=.git --exclude-dir=node_modules --exclude-dir=__pycache__; then
          echo "âš ï¸  í•˜ë“œì½”ë”©ëœ ë¹„ë°€ë²ˆí˜¸ íŒ¨í„´ ë°œê²¬" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… í•˜ë“œì½”ë”©ëœ ë¹„ë°€ë²ˆí˜¸ íŒ¨í„´ ì—†ìŒ" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "âœ… ì‹œí¬ë¦¿ ìŠ¤ìº” ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # ğŸ³ ì»¨í…Œì´ë„ˆ ë³´ì•ˆ ìŠ¤ìº”
  # =============================================================================
  container-security:
    name: ğŸ³ ì»¨í…Œì´ë„ˆ ë³´ì•ˆ
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ
      run: |
        docker build -f Dockerfile.base -t yt2-base:security .
        docker build -f api/Dockerfile -t yt2-api:security .
        docker build -f crawler/Dockerfile -t yt2-crawler:security .
        docker build -f frontend/Dockerfile -t yt2-frontend:security .
        
    - name: ğŸ” ì»¨í…Œì´ë„ˆ ì·¨ì•½ì  ìŠ¤ìº” (Trivy)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'yt2-api:security'
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: ğŸ“Š Trivy ìŠ¤ìº” ê²°ê³¼ ì—…ë¡œë“œ
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  # =============================================================================
  # ğŸ“Š ë³´ì•ˆ ë¦¬í¬íŠ¸ ìƒì„±
  # =============================================================================
  security-report:
    name: ğŸ“Š ë³´ì•ˆ ë¦¬í¬íŠ¸
    runs-on: ubuntu-latest
    needs: [security-scan, secret-scan, container-security]
    if: always()
    
    steps:
    - name: ğŸ“¥ ë³´ì•ˆ ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ
      uses: actions/download-artifact@v4
      with:
        name: security-reports-${{ github.run_number }}
        path: ./security-reports
        
    - name: ğŸ“Š ë³´ì•ˆ ë¦¬í¬íŠ¸ ìƒì„±
      run: |
        echo "# ğŸ”’ ë³´ì•ˆ ìŠ¤ìº” ë¦¬í¬íŠ¸" > security-summary.md
        echo "## ğŸ“… ìŠ¤ìº” ì¼ì‹œ: $(date)" >> security-summary.md
        echo "## ğŸŒ¿ ë¸Œëœì¹˜: ${{ github.ref_name }}" >> security-summary.md
        echo "## ğŸ”— ì»¤ë°‹: ${{ github.sha }}" >> security-summary.md
        echo "" >> security-summary.md
        
        if [ -f "security-reports/safety-report.json" ]; then
          echo "### ğŸ” ì˜ì¡´ì„± ì·¨ì•½ì " >> security-summary.md
          jq -r '.vulnerabilities[]? | "- \(.package_name): \(.advisory)"' security-reports/safety-report.json >> security-summary.md || true
        fi
        
        if [ -f "security-reports/bandit-api-report.json" ]; then
          echo "### ğŸ›¡ï¸ API ë³´ì•ˆ ì´ìŠˆ" >> security-summary.md
          jq -r '.results[]? | "- \(.test_name): \(.issue_severity) - \(.issue_text)"' security-reports/bandit-api-report.json >> security-summary.md || true
        fi
        
        echo "" >> security-summary.md
        echo "## âœ… ë³´ì•ˆ ìŠ¤ìº” ì™„ë£Œ" >> security-summary.md
        
    - name: ğŸ“¤ ë³´ì•ˆ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      with:
        name: security-summary
        path: security-summary.md
