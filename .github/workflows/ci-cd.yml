name: ğŸš€ CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * 1'  # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 2ì‹œ (í•œêµ­ ì‹œê°„ ì˜¤ì „ 11ì‹œ)

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # =============================================================================
  # ğŸ” ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  # =============================================================================
  code-quality:
    name: ğŸ” ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸ Python ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install black isort flake8 mypy safety bandit
        
    - name: ğŸ¨ Black í¬ë§·íŒ… ê²€ì‚¬
      run: black --check --diff api/ crawler/
      
    - name: ğŸ“‹ isort import ì •ë ¬ ê²€ì‚¬
      run: isort --check-only --diff api/ crawler/
      
    - name: ğŸ” Flake8 ë¦°íŒ… ê²€ì‚¬
      run: flake8 api/ crawler/ --max-line-length=88 --extend-ignore=E203,W503,E501
      
    - name: ğŸ” MyPy íƒ€ì… ê²€ì‚¬
      run: mypy api/ crawler/ --ignore-missing-imports
      
    - name: ğŸ”’ Safety ë³´ì•ˆ ê²€ì‚¬
      run: safety check --json --output safety-report.json || true
      
    - name: ğŸ”’ Bandit ë³´ì•ˆ ê²€ì‚¬
      run: bandit -r api/ crawler/ -f json -o bandit-report.json || true

  # =============================================================================
  # ğŸ—ï¸ Docker ë©€í‹° ì„œë¹„ìŠ¤ ë¹Œë“œ
  # =============================================================================
  docker-build-base:
    name: ğŸ—ï¸ Docker ë¹Œë“œ (Base)
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸ—ï¸ Base ì´ë¯¸ì§€ ë¹Œë“œ
      run: |
        docker build -f Dockerfile.base -t yt2-base:latest .
        docker images | grep yt2-base

  docker-build-services:
    name: ğŸ—ï¸ Docker ë¹Œë“œ (${{ matrix.service }})
    runs-on: ubuntu-latest
    needs: [code-quality, docker-build-base]
    strategy:
      matrix:
        service: [api, crawler, frontend]
        
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸ—ï¸ ì„œë¹„ìŠ¤ ì´ë¯¸ì§€ ë¹Œë“œ
      run: |
        if [ "${{ matrix.service }}" = "api" ]; then
          docker build -f api/Dockerfile -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-api:latest .
        elif [ "${{ matrix.service }}" = "crawler" ]; then
          docker build -f crawler/Dockerfile -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-crawler:latest .
        elif [ "${{ matrix.service }}" = "frontend" ]; then
          docker build -f frontend/Dockerfile -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:latest .
        fi
        docker images | grep ${{ env.IMAGE_NAME }}-${{ matrix.service }}

  # =============================================================================
  # ğŸ”’ ë³´ì•ˆ ìŠ¤ìº”
  # =============================================================================
  security-scan:
    name: ğŸ”’ ë³´ì•ˆ ìŠ¤ìº”
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸ Python ë³´ì•ˆ ìŠ¤ìº”
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ”’ Safety ë³´ì•ˆ ê²€ì‚¬
      run: |
        pip install safety
        safety check --json --output safety-report.json || true
        
    - name: ğŸ”’ Bandit ë³´ì•ˆ ê²€ì‚¬
      run: |
        pip install bandit
        bandit -r api/ crawler/ -f json -o bandit-report.json || true
        
    - name: ğŸ” Semgrep ë³´ì•ˆ ê²€ì‚¬
      uses: returntocorp/semgrep-action@v1
      with:
        config: >-
          p/security-audit
          p/secrets
          p/owasp-top-ten
        generateSarif: "1"
        
    - name: ğŸ” Trivy ì·¨ì•½ì  ìŠ¤ìº”
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: ğŸ“Š SARIF ì—…ë¡œë“œ
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: 'trivy-results.sarif'
      if: always()

  # =============================================================================
  # ğŸ§ª í†µí•© í…ŒìŠ¤íŠ¸
  # =============================================================================
  integration-test:
    name: ğŸ§ª í†µí•© í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: [docker-build-base, docker-build-services]
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸ Python ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install -r api/requirements.txt
        pip install pytest pytest-asyncio httpx
        
    - name: ğŸ§ª API í…ŒìŠ¤íŠ¸
      run: |
        python -m pytest test_integration.py -v
      env:
        DB_HOST: localhost
        DB_PORT: 5432
        DB_NAME: test_db
        DB_USER: postgres
        DB_PASSWORD: postgres
        REDIS_HOST: localhost
        REDIS_PORT: 6379

  # =============================================================================
  # ğŸš€ ë°°í¬
  # =============================================================================
  deploy:
    name: ğŸš€ ë°°í¬
    runs-on: ubuntu-latest
    needs: [integration-test, security-scan]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸ³ Docker Buildx ì„¤ì •
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ” GitHub Container Registry ë¡œê·¸ì¸
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ—ï¸ í”„ë¡œë•ì…˜ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile.base
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-base:latest
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-base:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: ğŸ“Š ë°°í¬ ì™„ë£Œ ì•Œë¦¼
      run: |
        echo "ğŸš€ ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
        echo "ì´ë¯¸ì§€: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-base:${{ github.sha }}"
