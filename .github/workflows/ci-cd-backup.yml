name: ğŸš€ CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # =============================================================================
  # ğŸ” ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  # =============================================================================
  code-quality:
    name: ğŸ“‹ ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸ Python ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ Python ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort mypy
        pip install -r api/requirements.txt
        pip install -r crawler/requirements.txt
        
    - name: ğŸ¨ ì½”ë“œ í¬ë§·íŒ… ê²€ì‚¬ (Black)
      run: |
        black --check --diff api/ crawler/
        
    - name: ğŸ“ Import ì •ë ¬ ê²€ì‚¬ (isort)
      run: |
        isort --check-only --diff api/ crawler/
        
    - name: ğŸ” ë¦°íŒ… ê²€ì‚¬ (Flake8)
      run: |
        flake8 api/ crawler/ --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 api/ crawler/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        
    - name: ğŸ”¬ íƒ€ì… ê²€ì‚¬ (MyPy)
      run: |
        mypy api/main.py --ignore-missing-imports || true

  # =============================================================================
  # ğŸ³ Docker ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
  # =============================================================================
  docker-build:
    name: ğŸ³ Docker ë¹Œë“œ
    runs-on: ubuntu-latest
    needs: code-quality
    
    strategy:
      matrix:
        service: [base, api, crawler, frontend]
        
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸ³ Docker Buildx ì„¤ì •
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ” GitHub Container Registry ë¡œê·¸ì¸
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ—ï¸ Docker ì´ë¯¸ì§€ ë¹Œë“œ
      uses: docker/build-push-action@v5
      with:
        context: .
        file: |
          ${{ matrix.service == 'base' && './Dockerfile.base' || '' }}
          ${{ matrix.service == 'api' && './api/Dockerfile' || '' }}
          ${{ matrix.service == 'crawler' && './crawler/Dockerfile' || '' }}
          ${{ matrix.service == 'frontend' && './frontend/Dockerfile' || '' }}
        push: false
        tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-${{ matrix.service }}:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # =============================================================================
  # ğŸ”’ ë³´ì•ˆ ìŠ¤ìº”
  # =============================================================================
  security-scan:
    name: ğŸ”’ ë³´ì•ˆ ìŠ¤ìº”
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸ Python ë³´ì•ˆ ìŠ¤ìº”
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ ë³´ì•ˆ ë„êµ¬ ì„¤ì¹˜
      run: |
        pip install safety bandit semgrep
        
    - name: ğŸ›¡ï¸ ì˜ì¡´ì„± ì·¨ì•½ì  ìŠ¤ìº” (Safety)
      run: |
        safety check -r api/requirements.txt -r crawler/requirements.txt || true
        
    - name: ğŸ” ë³´ì•ˆ ì½”ë“œ ë¶„ì„ (Bandit)
      run: |
        bandit -r api/ -f json -o bandit-report.json || true
        bandit -r crawler/ -f json -o bandit-crawler-report.json || true
        
    - name: ğŸ“Š ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports
        path: |
          bandit-report.json
          bandit-crawler-report.json

  # =============================================================================
  # ğŸ§ª í†µí•© í…ŒìŠ¤íŠ¸
  # =============================================================================
  integration-test:
    name: ğŸ§ª í†µí•© í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: [code-quality, docker-build]
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸ Python ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install -r api/requirements.txt
        pip install pytest pytest-asyncio httpx
        
    - name: ğŸ§ª í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: |
        python test_integration.py
      env:
        DB_HOST: localhost
        DB_PORT: 5432
        DB_NAME: test_db
        DB_USER: postgres
        DB_PASSWORD: test_password
        REDIS_HOST: localhost
        REDIS_PORT: 6379

  # =============================================================================
  # ğŸ“¦ í”„ë¡œë•ì…˜ ë°°í¬
  # =============================================================================
  deploy:
    name: ğŸš€ í”„ë¡œë•ì…˜ ë°°í¬
    runs-on: ubuntu-latest
    needs: [code-quality, docker-build, security-scan, integration-test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸ³ Docker Buildx ì„¤ì •
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ” GitHub Container Registry ë¡œê·¸ì¸
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ—ï¸ í”„ë¡œë•ì…˜ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-base:latest
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-api:latest
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-crawler:latest
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: ğŸ“¢ ë°°í¬ ì™„ë£Œ ì•Œë¦¼
      run: |
        echo "ğŸš€ í”„ë¡œë•ì…˜ ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
        echo "ğŸ“¦ ì´ë¯¸ì§€: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
        echo "ğŸ·ï¸ íƒœê·¸: latest"

  # =============================================================================
  # ğŸ“Š ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§
  # =============================================================================
  performance-test:
    name: ğŸ“Š ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: [docker-build]
    if: github.event_name == 'workflow_dispatch'
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸ³ Docker Composeë¡œ ì„œë¹„ìŠ¤ ì‹œì‘
      run: |
        docker-compose up -d --build
        
    - name: â±ï¸ ì„œë¹„ìŠ¤ ì¤€ë¹„ ëŒ€ê¸°
      run: |
        sleep 30
        
    - name: ğŸ§ª ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: |
        # API ì‘ë‹µ ì‹œê°„ í…ŒìŠ¤íŠ¸
        curl -w "@curl-format.txt" -o /dev/null -s "http://localhost:8000/health" || true
        
    - name: ğŸ“ˆ ì„±ëŠ¥ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
      run: |
        echo "ğŸ“Š ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ê²°ê³¼:"
        echo "- API ì‘ë‹µ ì‹œê°„: $(curl -w '%{time_total}' -o /dev/null -s http://localhost:8000/health)s"
        echo "- ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰: $(docker stats --no-stream --format 'table {{.MemUsage}}' yt2-api)"
        
    - name: ğŸ§¹ ì •ë¦¬
      if: always()
      run: |
        docker-compose down -v
